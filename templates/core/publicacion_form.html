{% extends 'base.html' %}
{% block title %}{{ accion }} publicación{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9 col-xl-8">
    <div class="card shadow rounded-4 mt-4 animate__animated animate__fadeInUp" data-aos="fade-up">
      <div class="card-body p-4">
        <h2 class="mb-4"><i class="bi bi-journal-plus me-2"></i>{{ accion }} publicación</h2>

        <form method="post" enctype="multipart/form-data" novalidate id="publicacionForm">
          {% csrf_token %}
          {{ form.non_field_errors }}

          <div class="row g-3">
            <div class="col-md-7">
              <div class="mb-2">
                {{ form.titulo.label_tag }}{{ form.titulo }}{{ form.titulo.errors }}
              </div>
              <div class="mb-2">
                {{ form.resumen.label_tag }}{{ form.resumen }}{{ form.resumen.errors }}
              </div>
              <!-- Autores (dinámicos) -->
              <div class="mb-2">
                <label class="form-label">Autores</label>
                <div id="authors-container" class="d-grid gap-2">
                  <div class="input-group">
                    <input type="text" name="autores_multi" class="form-control" placeholder="Nombre del autor">
                    <button type="button" class="btn btn-outline-secondary" onclick="addAuthorField()">
                      <i class="bi bi-plus-circle"></i>
                    </button>
                  </div>
                </div>
                <div class="form-text">Puedes agregar varios autores. Se guardarán combinados.</div>
                <!-- Mantener el campo del form para que el backend lo reciba -->
                <div style="display:none;">
                  {{ form.autores }}
                </div>
                {{ form.autores.errors }}
              </div>
              <div class="mb-2">
                {{ form.fecha.label_tag }}{{ form.fecha }}{{ form.fecha.errors }}
              </div>
            </div>

            <div class="col-md-5">
              <!-- Imagenes (dinámicas) -->
              <div class="dynamic-section mb-3">
                <h5><i class="bi bi-images me-2"></i>Imágenes</h5>
                {% if publicacion %}
                  <div class="mb-2">
                    <label class="form-label">Imágenes actuales:</label>
                    <div class="d-flex flex-wrap gap-2">
                      {% for img in publicacion.imagenes.all %}
                        {% if img.imagen %}
                          <img src="{{ img.imagen.url }}" alt="Imagen" class="rounded border" style="height:80px;object-fit:cover;">
                        {% endif %}
                      {% empty %}
                        <div class="text-muted small">No hay imágenes</div>
                      {% endfor %}
                    </div>
                    <p class="text-muted small mt-2">Para cambiar, sube nuevas imágenes abajo</p>
                  </div>
                {% endif %}
                <div id="imagenes-container">
                  <div class="mb-2">
                    <input type="file" name="imagenes" class="form-control" accept="image/*">
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-add-more" onclick="addImagenField()">
                  <i class="bi bi-plus-circle me-1"></i>Agregar otra imagen
                </button>
              </div>

              <!-- Videos (dinámicos) -->
              <div class="dynamic-section mb-3">
                <h5><i class="bi bi-camera-video me-2"></i>Videos</h5>
                {% if publicacion %}
                  <div class="mb-2">
                    <label class="form-label">Videos actuales:</label>
                    <ul class="list-group">
                      {% for v in publicacion.videos.all %}
                        {% if v.video %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <span><i class="bi bi-film me-2"></i>Video {{ forloop.counter }}</span>
                          <a href="{{ v.video.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i>
                          </a>
                        </li>
                        {% endif %}
                      {% empty %}
                        <li class="list-group-item text-muted">No hay videos</li>
                      {% endfor %}
                    </ul>
                    <p class="text-muted small mt-2">Para cambiar, sube nuevos videos abajo</p>
                  </div>
                {% endif %}
                <div id="videos-container">
                  <div class="mb-2">
                    <input type="file" name="videos" class="form-control" accept="video/*">
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-add-more" onclick="addVideoField()">
                  <i class="bi bi-plus-circle me-1"></i>Agregar otro video
                </button>
              </div>

              <!-- Archivos (dinámicos) -->
              <div class="dynamic-section mb-3">
                <h5><i class="bi bi-file-earmark-arrow-down me-2"></i>Archivos para descargar</h5>
                {% if publicacion %}
                  <div class="mb-2">
                    <label class="form-label">Archivos actuales:</label>
                    <ul class="list-group">
                      {% for a in publicacion.archivos.all %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-file-earmark-text me-2"></i>{{ a.nombre|default:a.archivo.name }}</span>
                        <a href="{{ a.archivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i></a>
                      </li>
                      {% empty %}
                      <li class="list-group-item text-muted">No hay archivos</li>
                      {% endfor %}
                    </ul>
                    <p class="text-muted small mt-2">Para cambiar, sube nuevos archivos abajo</p>
                  </div>
                {% endif %}
                <div id="archivos-container">
                  <div class="mb-2">
                    <input type="file" name="archivos" class="form-control mb-2" accept=".pdf,.doc,.docx">
                    <input type="text" name="archivo_nombre" class="form-control" placeholder="Nombre para mostrar (opcional)">
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-add-more" onclick="addArchivoField()">
                  <i class="bi bi-plus-circle me-1"></i>Agregar otro archivo
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-success px-3"><i class="bi bi-check2-circle me-1"></i>{{ accion }}</button>
            <a href="{% url 'core:panel_publicaciones' %}" class="btn btn-outline-secondary">Cancelar</a>
          </div>
        </form>
        
      </div>
    </div>
  </div>
</div>

<script>
function addImagenField(){
  const c = document.getElementById('imagenes-container');
  const div = document.createElement('div');
  div.className = 'mb-2';
  div.innerHTML = `<input type="file" name="imagenes" class="form-control" accept="image/*">`;
  c.appendChild(div);
}
function addVideoField(){
  const c = document.getElementById('videos-container');
  const div = document.createElement('div');
  div.className = 'mb-2';
  div.innerHTML = `<input type="file" name="videos" class="form-control" accept="video/*">`;
  c.appendChild(div);
}
function addArchivoField(){
  const c = document.getElementById('archivos-container');
  const div = document.createElement('div');
  div.className = 'mb-2';
  div.innerHTML = `
    <input type="file" name="archivos" class="form-control mb-2" accept=".pdf,.doc,.docx">
    <input type="text" name="archivo_nombre" class="form-control" placeholder="Nombre para mostrar (opcional)">
  `;
  c.appendChild(div);
}
function addAuthorField(){
  const c = document.getElementById('authors-container');
  const wrap = document.createElement('div');
  wrap.className = 'input-group';
  wrap.innerHTML = `
    <input type="text" name="autores_multi" class="form-control" placeholder="Nombre del autor">
    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
      <i class="bi bi-x"></i>
    </button>
  `;
  c.appendChild(wrap);
}
// Serializar autores_multi -> campo oculto autores antes de enviar
document.addEventListener('DOMContentLoaded', function(){
  const form = document.querySelector('form#publicacionForm') || document.querySelector('form');
  const hiddenAutores = document.getElementById('id_autores') || document.querySelector('input[name="autores"]');
  // Prellenar inputs múltiples en modo edición
  if (hiddenAutores && hiddenAutores.value){
    const values = hiddenAutores.value.split(',');
    const container = document.getElementById('authors-container');
    container.innerHTML = '';
    values.forEach(v => {
      const name = v.trim();
      if (!name) return;
      const row = document.createElement('div');
      row.className = 'input-group mb-2';
      row.innerHTML = `
        <input type="text" name="autores_multi" class="form-control" value="${name}">
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
          <i class="bi bi-x"></i>
        </button>
      `;
      container.appendChild(row);
    });
    if (!container.children.length){
      addAuthorField();
    }
  } else {
    // Asegurar al menos un input
    addAuthorField();
  }
  if (form){
    form.addEventListener('submit', function(){
      const fields = Array.from(document.querySelectorAll('input[name="autores_multi"]'));
      const names = fields.map(i => i.value.trim()).filter(Boolean);
      if (hiddenAutores){ hiddenAutores.value = names.join(', '); }
    });
  }
});
</script>
{% endblock %}
