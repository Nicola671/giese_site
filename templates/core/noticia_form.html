{% extends 'base.html' %}
{% block content %}
<style>
  .dynamic-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .dynamic-section h5 {
    color: #1a4d2e;
    font-weight: 600;
    margin-bottom: 1rem;
  }
  .dynamic-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    position: relative;
  }
  .btn-remove-item {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  .btn-add-more {
    background: linear-gradient(135deg, #7fc242, #4a7c59);
    border: none;
    color: white;
    font-weight: 500;
  }
  .btn-add-more:hover {
    background: linear-gradient(135deg, #6ba835, #3a6348);
    color: white;
  }
</style>

<div class="row justify-content-center">
  <div class="col-md-10 col-lg-9">
    <div class="card shadow rounded-4 mt-5 animate__animated animate__fadeInUp">
      <div class="card-body p-4">
        <h2 class="mb-4 text-center text-success">
          <i class="bi bi-newspaper me-2"></i>{{ accion }} noticia
        </h2>
        
        {% include 'core/_messages.html' %}
        
        <form method="post" enctype="multipart/form-data" id="noticiaForm">
          {% csrf_token %}
          {{ form.non_field_errors }}
          
          <!-- Título -->
          <div class="mb-3">
            {{ form.titulo.label_tag }}
            {{ form.titulo }}
            {{ form.titulo.errors }}
          </div>
          
          <!-- Contenido -->
          <div class="mb-3">
            {{ form.contenido.label_tag }}
            {{ form.contenido }}
            {{ form.contenido.errors }}
          </div>
          
          <!-- Imagen principal (opcional) -->
          <div class="mb-3">
            {{ form.imagen.label_tag }}
            {{ form.imagen }}
            <small class="form-text text-muted">Imagen de portada (opcional si agregas imágenes adicionales abajo)</small>
            {{ form.imagen.errors }}
            {% if noticia.imagen %}
            <div class="mt-2">
              <img src="{{ noticia.imagen.url }}" alt="Imagen actual" class="img-thumbnail" style="max-height: 150px;">
              <p class="text-muted small mt-1">Imagen actual. Sube una nueva para reemplazarla.</p>
            </div>
            {% endif %}
          </div>
          
          <!-- Imágenes adicionales (dinámicas) -->
          <div class="dynamic-section">
            <h5><i class="bi bi-images me-2"></i>Imágenes adicionales</h5>
            
            {% if noticia %}
            <!-- Mostrar imágenes existentes -->
            <div class="mb-3">
              <label class="form-label">Imágenes actuales:</label>
              <div class="row g-2">
                {% for img in noticia.imagenes.all %}
                <div class="col-4 col-md-3">
                  <img src="{{ img.imagen.url }}" alt="Imagen {{ forloop.counter }}" class="img-thumbnail" style="width: 100%; height: 100px; object-fit: cover;">
                </div>
                {% empty %}
                <div class="col-12">
                  <p class="text-muted small">No hay imágenes adicionales</p>
                </div>
                {% endfor %}
              </div>
              <p class="text-muted small mt-2">Para cambiar las imágenes, sube nuevas abajo (se reemplazarán todas)</p>
            </div>
            {% endif %}
            
            <div id="imagenes-container">
              <div class="dynamic-item">
                <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item" onclick="removeItem(this)" style="display: none;">
                  <i class="bi bi-x-lg"></i>
                </button>
                <label class="form-label">Seleccionar imagen</label>
                <input type="file" name="imagenes_adicionales" class="form-control" accept="image/*">
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-add-more" onclick="addImagenField()">
              <i class="bi bi-plus-circle me-1"></i>Agregar otra imagen
            </button>
          </div>
          
          <!-- Video -->
          <div class="mb-3">
            {{ form.video.label_tag }}
            {{ form.video }}
            <small class="form-text text-muted">Archivo de video (MP4, WebM, etc.) - Opcional</small>
            {{ form.video.errors }}
            {% if noticia.video %}
            <div class="mt-2">
              <video controls style="max-width: 100%; max-height: 200px;" class="rounded">
                <source src="{{ noticia.video.url }}" type="video/mp4">
                Tu navegador no soporta el elemento de video.
              </video>
              <p class="text-muted small mt-1">Video actual. Sube uno nuevo para reemplazarlo.</p>
            </div>
            {% endif %}
          </div>
          
          <!-- Fecha -->
          <div class="mb-3">
            {{ form.fecha.label_tag }}
            {{ form.fecha }}
            <small class="form-text text-muted">Fecha en que ocurrió la noticia</small>
            {{ form.fecha.errors }}
          </div>
          
          <!-- Responsable (automático: usuario actual) -->
          <div class="alert alert-info">
            <i class="bi bi-person-check me-2"></i>
            <strong>Responsable:</strong> {{ request.user.get_full_name|default:request.user.username }}
          </div>
          
          <button type="submit" class="btn btn-success w-100 py-2">
            <i class="bi bi-check-circle me-2"></i>{{ accion }} noticia
          </button>
          <a href="{% url 'core:panel_noticias' %}" class="btn btn-outline-secondary w-100 mt-2">
            <i class="bi bi-x-circle me-2"></i>Cancelar
          </a>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function addImagenField() {
  const container = document.getElementById('imagenes-container');
  const newItem = document.createElement('div');
  newItem.className = 'dynamic-item';
  newItem.innerHTML = `
    <button type="button" class="btn btn-sm btn-outline-danger btn-remove-item" onclick="removeItem(this)">
      <i class="bi bi-x-lg"></i>
    </button>
    <label class="form-label">Seleccionar imagen</label>
    <input type="file" name="imagenes_adicionales" class="form-control" accept="image/*">
  `;
  container.appendChild(newItem);
}

function removeItem(btn) {
  const item = btn.closest('.dynamic-item');
  // Solo permitir eliminar si hay más de un campo
  const container = document.getElementById('imagenes-container');
  if (container.children.length > 1) {
    item.remove();
  }
}
</script>
{% endblock %}
