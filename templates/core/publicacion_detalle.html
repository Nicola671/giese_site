{% extends 'base.html' %}
{% block title %}{{ publicacion.titulo }} | Publicaciones{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary-color: #2c5530;
    --secondary-color: #4a7c59;
    --accent-color: #6ab7ff;
    --light-bg: #f8fffe;
    --shadow-light: 0 4px 20px rgba(44, 85, 48, 0.1);
    --shadow-medium: 0 8px 30px rgba(44, 85, 48, 0.15);
  }

  .hero-publication {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 3rem 0;
    margin-bottom: 0;
    position: relative;
    overflow: hidden;
  }

  .hero-publication::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M20 20c0-11.046-8.954-20-20-20v20h20z'/%3E%3C/g%3E%3C/svg%3E") repeat;
  }

  .publication-content {
    background: white;
    margin-top: -2rem;
    border-radius: 2rem 2rem 0 0;
    position: relative;
    z-index: 2;
    padding: 3rem 0;
  }

  .publication-header {
    text-align: center;
    margin-bottom: 3rem;
    position: relative;
    z-index: 1;
  }

  .publication-title {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1.5rem;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Compact centered cover image */
  .main-image {
    display: block;
    margin: 0 auto 1.25rem;
    max-height: 100px; /* mucho más chica */
    max-width: 60%;   /* menos ancha */
    width: auto;
    height: auto;
    object-fit: contain; /* no recortar */
    border-radius: 12px;
    box-shadow: var(--shadow-medium);
    transition: transform .3s ease;
  }
  .main-image:hover { transform: scale(1.01); }

  .publication-meta {
    display: flex;
    justify-content: center;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--secondary-color);
    font-size: 4rem;
    margin-bottom: 3rem;
    border: 2px dashed var(--secondary-color);
    opacity: 0.7;
  }

  .abstract-section {
    background: white;
    padding: 2.5rem;
    border-radius: 20px;
    box-shadow: var(--shadow-light);
    margin-bottom: 3rem;
    border: 1px solid rgba(44, 85, 48, 0.1);
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, var(--secondary-color), transparent);
  }

  .abstract-text {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #444;
    text-align: justify;
  }

  .actions-section {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: var(--shadow-light);
    margin-bottom: 3rem;
    text-align: center;
  }

  .action-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .btn-action {
    padding: 1rem 2rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1.1rem;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 180px;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .btn-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s ease;
  }

  .btn-action:hover::before {
    left: 100%;
  }

  .btn-primary-action {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
  }

  .btn-primary-action:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(44, 85, 48, 0.3);
    color: white;
  }

  .btn-outline-action {
    background: transparent;
    color: var(--secondary-color);
    border: 2px solid var(--secondary-color);
  }

  .btn-outline-action:hover {
    background: var(--secondary-color);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(74, 124, 89, 0.3);
  }

  .video-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: var(--shadow-medium);
    margin-bottom: 3rem;
  }

  .video-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .back-navigation {
    margin-bottom: 2rem;
  }

  .btn-back {
    color: white;
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
  }

  .btn-back:hover {
    background: rgba(255, 255, 255, 0.3);
    color: white;
    transform: translateX(-5px);
  }

  .additional-images {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
  }

  @media (max-width: 768px) {
    .main-image { max-height: 80px; max-width: 75%; }
  }

  .breadcrumb-custom {
    background: transparent;
    padding: 0;
    margin-bottom: 2rem;
  }

  .breadcrumb-custom .breadcrumb-item {
    color: rgba(255, 255, 255, 0.8);
  }

  .breadcrumb-custom .breadcrumb-item.active {
    color: white;
  }

  .breadcrumb-custom .breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    color: rgba(255, 255, 255, 0.6);
  }

  .fade-in {
    animation: fadeIn 0.8s ease forwards;
    opacity: 0;
  }

  .slide-up {
    animation: slideUp 0.6s ease forwards;
    opacity: 0;
    transform: translateY(30px);
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .slide-up:nth-child(1) { animation-delay: 0.1s; }
  .slide-up:nth-child(2) { animation-delay: 0.2s; }
  .slide-up:nth-child(3) { animation-delay: 0.3s; }
  .slide-up:nth-child(4) { animation-delay: 0.4s; }

  @media (max-width: 768px) {
    .hero-publication {
      padding: 2rem 0;
    }

    .publication-content {
      padding: 2rem 0;
      margin-top: -1rem;
    }

    .publication-title {
      font-size: 1.8rem;
    }

    .publication-meta {
      flex-direction: column;
      gap: 1rem;
    }

    .action-buttons {
      flex-direction: column;
      align-items: center;
    }

    .btn-action {
      min-width: 100%;
    }

    .authors-section,
    .abstract-section,
    .actions-section {
      padding: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-publication">
  <div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb-custom">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'core:publicaciones' %}" class="text-white text-decoration-none">
            Publicaciones
          </a>
        </li>
        <li class="breadcrumb-item active">{{ publicacion.titulo|truncatechars:40 }}</li>
      </ol>
    </nav>

    <!-- Back Button -->
    <div class="back-navigation">
      <a href="{% url 'core:publicaciones' %}" class="btn-back">
        <i class="bi bi-arrow-left"></i>
        Volver a publicaciones
      </a>
    </div>

    <!-- Publication Header -->
    <div class="publication-header fade-in">
      <h1 class="publication-title">{{ publicacion.titulo }}</h1>
      
      <div class="publication-meta">
        <div class="meta-item">
          <i class="bi bi-calendar3"></i>
          <span>{{ publicacion.fecha|date:"d F Y" }}</span>
        </div>
        {% if publicacion.autores %}
        <div class="meta-item">
          <i class="bi bi-people-fill"></i>
          <span>{{ publicacion.autores|truncatechars:50 }}</span>
        </div>
        {% endif %}
        <div class="meta-item">
          <i class="bi bi-journal-bookmark"></i>
          <span>Publicación Científica</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="publication-content">
  <div class="container">
    
    <!-- Authors Section -->
    {% if publicacion.autores %}
    <div class="authors-section slide-up">
      <div class="authors-title">
        <i class="bi bi-person-badge-fill"></i>
        Autores
      </div>
      <div class="authors-list">
        {% with det=publicacion.autores_detalle.all %}
          {% if det and det|length > 0 %}
            {% for autor in det %}
              {{ autor }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            {{ publicacion.autores }}
          {% endif %}
        {% endwith %}
      </div>
    </div>
    {% endif %}

    <!-- Main Image (first from imagenes) -->
    <div class="slide-up">
      {% with imgs=publicacion.imagenes.all %}
        {% if imgs and imgs|length > 0 %}
          {% for img in imgs|slice:":1" %}
            {% if img.imagen %}
              <img src="{{ img.imagen.url }}" alt="{{ publicacion.titulo }}" class="main-image">
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="image-placeholder">
            <i class="bi bi-file-earmark-text-fill"></i>
          </div>
        {% endif %}
      {% endwith %}
    </div>

    <!-- Abstract/Summary -->
    {% if publicacion.resumen %}
    <div class="abstract-section slide-up">
      <h2 class="section-title">
        <i class="bi bi-file-text-fill"></i>
        Resumen
      </h2>
      <div class="abstract-text">
        {{ publicacion.resumen|linebreaks }}
      </div>
    </div>
    {% endif %}

    <!-- Video Section (from related videos) -->
    {% if publicacion.videos.all|length %}
    <div class="slide-up">
      <h2 class="section-title">
        <i class="bi bi-camera-video-fill"></i>
        Videos
      </h2>
      {% for v in publicacion.videos.all %}
      {% if v.video %}
      <div class="video-container mb-4">
        <video controls preload="metadata">
          <source src="{{ v.video.url }}" type="video/mp4">
          Tu navegador no soporta la reproducción de video.
        </video>
      </div>
      {% endif %}
      {% endfor %}
    </div>
    {% endif %}

    <!-- Additional Images -->
    {% if publicacion.imagenes.all %}
    <div class="slide-up">
      <h2 class="section-title">
        <i class="bi bi-images"></i>
        Galería de Imágenes
      </h2>
      <div class="additional-images">
        {% for img in publicacion.imagenes.all %}
          {% if img.imagen %}
          <img src="{{ img.imagen.url }}" alt="Imagen adicional" class="additional-image" 
               onclick="openImageModal('{{ img.imagen.url }}')" loading="lazy">
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Actions Section: Downloads -->
    <div class="actions-section slide-up">
      <h2 class="section-title">
        <i class="bi bi-download"></i>
        Descargas
      </h2>
      {% if publicacion.archivos.all|length %}
        <div class="d-grid gap-2 d-md-flex justify-content-md-center flex-wrap">
          {% for a in publicacion.archivos.all %}
            <a href="{{ a.archivo.url }}" class="btn-action btn-primary-action" download>
              <i class="bi bi-download"></i>
              {{ a.nombre|default:a.archivo.name }}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted mt-2 text-center">
          <i class="bi bi-info-circle me-2"></i>
          No hay archivos para descargar.
        </div>
      {% endif %}
      <div class="text-center mt-3">
        <a href="{% url 'core:publicaciones' %}" class="btn-action btn-outline-action">
          <i class="bi bi-arrow-left-circle"></i>
          Más Publicaciones
        </a>
      </div>
    </div>

  </div>
</div>

<!-- Modal para imágenes -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-header border-0">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center p-0">
        <img id="modalImage" src="" alt="Imagen ampliada" class="img-fluid rounded">
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones de scroll reveal
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('fade-in');
            }
        });
    }, observerOptions);

    // Observar elementos para animación
    document.querySelectorAll('.slide-up, .fade-in').forEach(el => {
        observer.observe(el);
    });

    // Smooth scroll para navegación
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Función para el video
    const video = document.querySelector('video');
    if (video) {
        video.addEventListener('loadedmetadata', function() {
            console.log('Video cargado correctamente');
        });

        video.addEventListener('error', function(e) {
            console.error('Error cargando el video:', e);
            const container = video.parentElement;
            container.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                    <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                    <p>No se pudo cargar el video</p>
                    <a href="${video.src}" target="_blank" class="btn btn-outline-secondary">
                        Ver en nueva pestaña
                    </a>
                </div>
            `;
        });
    }
});

// Función para abrir modal de imagen
function openImageModal(imageSrc) {
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    document.getElementById('modalImage').src = imageSrc;
    modal.show();
}

// Función para compartir (opcional)
function sharePublication() {
    if (navigator.share) {
        navigator.share({
            title: document.title,
            text: 'Publicación científica: {{ publicacion.titulo }}',
            url: window.location.href
        });
    } else {
        // Fallback: copiar URL al portapapeles
        navigator.clipboard.writeText(window.location.href).then(() => {
            // Mostrar notification toast
            showToast('URL copiada al portapapeles');
        });
    }
}

function showToast(message) {
    // Crear toast simple
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 start-50 translate-middle-x bg-success text-white px-4 py-2 rounded-3 mt-3';
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}