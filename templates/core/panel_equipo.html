{% extends 'base.html' %}
{% block title %}Panel del Equipo | GIESE{% endblock %}

{% block head %}
<style>
  :root {
    --primary-color: #7fc242;
    --primary-dark: #6ba836;
    --secondary-color: #4a7c59;
    --danger-color: #dc3545;
    --text-color: #1a4d2e;
    --bg-gradient-1: #f8fffe;
    --bg-gradient-2: #e8f5e8;
    --shadow-color: rgba(26, 77, 46, 0.15);
  }

  * {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .form-admin {
    background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  /* Animated background particles */
  .form-admin::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
      radial-gradient(circle at 20% 30%, rgba(127, 194, 66, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(74, 124, 89, 0.1) 0%, transparent 50%);
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
  }

  .form-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    box-shadow: 0 20px 60px var(--shadow-color);
    overflow: hidden;
    animation: slideUp 0.6s ease-out;
    position: relative;
    z-index: 1;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    padding: 2.5rem;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .form-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    animation: rotate 30s linear infinite;
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .form-header h2 {
    position: relative;
    z-index: 1;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .form-header p {
    position: relative;
    z-index: 1;
    opacity: 0.95;
  }

  .form-section {
    background: linear-gradient(135deg, #f0f8f4 0%, #ffffff 100%);
    margin: 1.5rem;
    padding: 2rem;
    border-radius: 16px;
    border-left: 5px solid var(--primary-color);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    animation: fadeIn 0.5s ease-out backwards;
  }

  .form-section:nth-child(1) { animation-delay: 0.1s; }
  .form-section:nth-child(2) { animation-delay: 0.2s; }
  .form-section:nth-child(3) { animation-delay: 0.3s; }
  .form-section:nth-child(4) { animation-delay: 0.4s; }
  .form-section:nth-child(5) { animation-delay: 0.5s; }
  .form-section:nth-child(6) { animation-delay: 0.6s; }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .form-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    border-left-width: 7px;
  }

  .form-section h5 {
    color: var(--text-color);
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.3rem;
  }

  .form-section h5 i {
    font-size: 1.5rem;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .form-control, .form-select {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-control:hover {
    border-color: var(--primary-color);
    transform: translateY(-1px);
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.3rem rgba(127, 194, 66, 0.15);
    transform: scale(1.01);
  }

  .form-label {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .required::after {
    content: " *";
    color: var(--danger-color);
    font-weight: bold;
    animation: blink 2s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .preview-img {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 16px;
    border: 3px dashed var(--primary-color);
    padding: 10px;
    background: white;
    transition: all 0.4s ease;
  }

  .preview-img:hover {
    transform: scale(1.02) rotate(1deg);
    box-shadow: 0 10px 30px rgba(127, 194, 66, 0.3);
  }

  .dynamic-item {
    background: white;
    border: 2px solid #e8f5e8 !important;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    position: relative;
    animation: slideIn 0.4s ease-out;
    transition: all 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  .dynamic-item:hover {
    border-color: var(--primary-color) !important;
    transform: translateX(5px);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
  }

  .btn-close {
    transition: all 0.3s ease;
  }

  .btn-close:hover {
    transform: rotate(90deg) scale(1.2);
    background-color: var(--danger-color);
  }

  .btn-save {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border: none;
    color: white;
    padding: 14px 40px;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1.1rem;
    box-shadow: 0 8px 20px rgba(127, 194, 66, 0.3);
    position: relative;
    overflow: hidden;
  }

  .btn-save::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  .btn-save:hover::before {
    width: 300px;
    height: 300px;
  }

  .btn-save:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 30px rgba(127, 194, 66, 0.5);
    color: white;
  }

  .btn-save:active {
    transform: translateY(-1px) scale(1.02);
  }

  .btn-outline-success, .btn-outline-secondary {
    border-width: 2px;
    border-radius: 50px;
    padding: 10px 25px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-outline-success {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }

  .btn-outline-success:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(127, 194, 66, 0.3);
  }

  .btn-outline-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .error-message {
    color: var(--danger-color);
    font-size: 0.875rem;
    margin-top: 0.5rem;
    font-weight: 600;
    animation: shake 0.5s ease;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  .alert {
    border-radius: 12px;
    border: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.4s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Iconos animados */
  .bi {
    transition: all 0.3s ease;
  }

  .form-label:hover .bi,
  .btn:hover .bi {
    transform: scale(1.2) rotate(5deg);
  }

  /* Loading indicator */
  .form-container.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    animation: loading 1.5s ease-in-out infinite;
  }

  @keyframes loading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* Responsive improvements */
  @media (max-width: 768px) {
    .form-section {
      margin: 1rem;
      padding: 1.5rem;
    }

    .form-header {
      padding: 2rem 1rem;
    }

    .btn-save {
      width: 100%;
      margin-bottom: 1rem;
    }
  }

  /* Input focus glow effect */
  .form-control:focus {
    animation: glow 1.5s ease-in-out infinite alternate;
  }

  @keyframes glow {
    from {
      box-shadow: 0 0 0 0.3rem rgba(127, 194, 66, 0.15);
    }
    to {
      box-shadow: 0 0 0 0.3rem rgba(127, 194, 66, 0.25), 0 0 20px rgba(127, 194, 66, 0.1);
    }
  }

  /* Success border animation */
  .form-control.valid {
    border-color: var(--primary-color);
    animation: successPulse 0.6s ease;
  }

  @keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }

  /* Smooth scroll */
  html {
    scroll-behavior: smooth;
  }
</style>
{% endblock %}

{% block content %}
<div class="form-admin">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="form-container">
          <!-- Header -->
          <div class="form-header text-white">
            <h2 class="mb-2">
              <i class="bi bi-person-add me-2"></i>{{ accion }} Integrante del Equipo
            </h2>
            <p class="mb-0">Completá la información del miembro del equipo. Los campos obligatorios están marcados con (*).</p>
          </div>

          <form method="post" enctype="multipart/form-data" class="p-4" id="teamForm">
            {% csrf_token %}
            
            <!-- Mostrar errores generales del formulario -->
            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <!-- SECCIÓN 1: INFORMACIÓN PERSONAL -->
            <div class="form-section">
              <h5><i class="bi bi-person-circle"></i> Información Personal</h5>

              <div class="row">
                <div class="col-md-8">
                  <div class="mb-3">
                    <label for="id_nombre" class="form-label required">
                      <i class="bi bi-pencil-fill"></i> Nombre completo
                    </label>
                    <input type="text" class="form-control" id="id_nombre" name="nombre" placeholder="Ej: María García" value="{{ form.nombre.value|default:'' }}" required aria-describedby="nombreHelp">
                    {% if form.errors.nombre %}
                      <div class="error-message">{{ form.errors.nombre }}</div>
                    {% endif %}
                    <small id="nombreHelp" class="form-text text-muted">Ingresa el nombre completo</small>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="id_dni" class="form-label">
                      <i class="bi bi-card-text"></i> DNI
                    </label>
                    <input type="text" class="form-control" id="id_dni" name="dni" placeholder="12345678" value="{{ form.dni.value|default:'' }}" pattern="[0-9]{7,9}" aria-describedby="dniHelp">
                    {% if form.errors.dni %}
                      <div class="error-message">{{ form.errors.dni }}</div>
                    {% endif %}
                    <small id="dniHelp" class="form-text text-muted">Sólo números (7-9 dígitos)</small>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="id_descripcion" class="form-label">
                  <i class="bi bi-chat-left-text-fill"></i> Descripción
                </label>
                <textarea class="form-control" id="id_descripcion" name="descripcion" rows="4" placeholder="Información adicional sobre la persona">{{ form.descripcion.value|default:'' }}</textarea>
                {% if form.errors.descripcion %}
                  <div class="error-message">{{ form.errors.descripcion }}</div>
                {% endif %}
              </div>
            </div>

            <!-- SECCIÓN: REDES SOCIALES Y CONTACTO -->
            <div class="form-section">
              <h5><i class="bi bi-share-fill"></i> Redes Sociales y Contacto</h5>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_linkedin_url" class="form-label">
                      <i class="bi bi-linkedin text-primary"></i> URL de LinkedIn
                    </label>
                    <input type="url" class="form-control" id="id_linkedin_url" name="linkedin_url" placeholder="https://www.linkedin.com/in/usuario" value="{{ form.instance.linkedin_url|default:'' }}">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_email_publico" class="form-label">
                      <i class="bi bi-envelope-at-fill text-danger"></i> Email Público de Contacto
                    </label>
                    <input type="email" class="form-control" id="id_email_publico" name="email_publico" placeholder="contacto@ejemplo.com" value="{{ form.instance.email_publico|default:'' }}">
                  </div>
                </div>
              </div>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle"></i> Estos enlaces se mostrarán públicamente en la tarjeta del miembro del equipo.
              </small>
            </div>

            <!-- SECCIÓN: ROLES / PROFESIONALIDAD -->
            <div class="form-section">
              <h5><i class="bi bi-briefcase-fill"></i> Roles / Profesionalidad</h5>
              <div id="profesionalidad-list">
                {# Si estamos editando, cargamos los roles existentes #}
                {% for rol in persona.profesionalidades.all %}
                  <div class="dynamic-item border rounded">
                    <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.remove()"></button>
                    <div class="mb-2">
                      <label class="form-label"><i class="bi bi-award-fill"></i> Rol / Cargo</label>
                      <input type="text" name="profesionalidad_titulo" class="form-control" value="{{ rol.titulo }}">
                    </div>
                    <div>
                      <label class="form-label"><i class="bi bi-file-text"></i> Descripción de este rol (opcional)</label>
                      <textarea name="profesionalidad_descripcion" class="form-control" rows="2">{{ rol.descripcion }}</textarea>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addProfesionalidad()">
                <i class="bi bi-plus-circle-fill"></i> Agregar Otro Rol
              </button>
            </div>

            <!-- SECCIÓN 2: FOTO -->
            <div class="form-section">
              <h5><i class="bi bi-image-fill"></i> Foto del Integrante</h5>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_foto_archivo" class="form-label">
                      <i class="bi bi-cloud-upload-fill"></i> Subir archivo de imagen
                    </label>
                    <input type="file" class="form-control" id="id_foto_archivo" name="foto_archivo" accept="image/*" aria-describedby="fotoArchivoHelp">
                    {% if form.errors.foto_archivo %}
                      <div class="error-message">{{ form.errors.foto_archivo }}</div>
                    {% endif %}
                    <small id="fotoArchivoHelp" class="form-text text-muted">PNG, JPG, WEBP soportados</small>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_foto" class="form-label">
                      <i class="bi bi-link-45deg"></i> O usar URL de imagen
                    </label>
                    <input type="url" class="form-control" id="id_foto" name="foto" placeholder="https://ejemplo.com/imagen.jpg" value="{{ form.foto.value|default:'' }}">
                    {% if form.errors.foto %}
                      <div class="error-message">{{ form.errors.foto }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Preview de imagen -->
              <div class="mb-3" id="previewContainer">
                <label class="form-label"><i class="bi bi-eye-fill"></i> Vista previa:</label>
                <img id="imagePreview" class="preview-img" style="display: none;" alt="Vista previa de la imagen">
                <div id="imageError" class="error-message" style="display: none;">
                  <i class="bi bi-exclamation-circle-fill"></i> No se pudo cargar la imagen. Verifica el archivo o la URL.
                </div>
              </div>
            </div>

            <!-- SECCIÓN 3: FORMACIÓN ACADÉMICA -->
            <div class="form-section">
              <h5><i class="bi bi-mortarboard-fill"></i> Formación Académica</h5>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="id_nivel" class="form-label">
                      <i class="bi bi-journal-bookmark-fill"></i> Nivel de formación más alto
                    </label>
                    <input type="text" class="form-control" id="id_nivel" name="nivel" placeholder="Ej: Doctorado, Licenciatura, Maestría..." value="{{ form.nivel.value|default:'' }}" aria-describedby="nivelHelp">
                    {% if form.errors.nivel %}
                      <div class="error-message">{{ form.errors.nivel }}</div>
                    {% endif %}
                    <small id="nivelHelp" class="form-text text-muted">Escribe el nivel de formación más alto alcanzado</small>
                  </div>
                </div>
                <div class="col-md-6">
                   <div class="mb-3">
                    <label for="id_nivel_descripcion" class="form-label">
                      <i class="bi bi-text-paragraph"></i> Descripción del Nivel de Formación
                    </label>
                    <textarea class="form-control" id="id_nivel_descripcion" name="nivel_descripcion" rows="3" placeholder="Detalles específicos sobre la formación (Ej: Tesis sobre...)">{{ form.nivel_descripcion.value|default:'' }}</textarea>
                    {% if form.errors.nivel_descripcion %}
                      <div class="error-message">{{ form.errors.nivel_descripcion }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <!-- Universidades Dinámicas -->
              <div id="universidad-list">
                {# Si estamos editando, cargamos las universidades existentes #}
                {% for eu in persona.equipo_universidades.all %}
                  <div class="dynamic-item border rounded">
                    <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.remove()"></button>
                    <div class="mb-2">
                      <label class="form-label"><i class="bi bi-building"></i> Universidad</label>
                      <input type="text" name="universidad_nombre" class="form-control" value="{{ eu.universidad.descripcion_universidad }}">
                    </div>
                    <div>
                      <label class="form-label"><i class="bi bi-file-text"></i> Descripción (opcional)</label>
                      <textarea name="universidad_descripcion" class="form-control" rows="2">{{ eu.descripcion }}</textarea>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addUniversidad()">
                <i class="bi bi-plus-circle-fill"></i> Agregar Universidad
              </button>
            </div>

            <!-- SECCIÓN 4: TEMAS DE INTERÉS -->
            <div class="form-section">
              <h5><i class="bi bi-bookmark-heart-fill"></i> Temas de Interés</h5>
              
              <!-- Intereses Dinámicos -->
              <div id="interes-list">
                {# Si estamos editando, cargamos los intereses existentes #}
                {% for ei in persona.equipo_intereses.all %}
                  <div class="dynamic-item border rounded">
                    <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.remove()"></button>
                    <div class="mb-2">
                      <label class="form-label"><i class="bi bi-star-fill"></i> Tema de Interés</label>
                      <input type="text" name="interes_nombre" class="form-control" value="{{ ei.tema_interes.descripcion_interes }}">
                    </div>
                    <div>
                      <label class="form-label"><i class="bi bi-file-text"></i> Descripción (opcional)</label>
                      <textarea name="interes_descripcion" class="form-control" rows="2">{{ ei.descripcion }}</textarea>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addInteres()">
                <i class="bi bi-plus-circle-fill"></i> Agregar Tema de Interés
              </button>
            </div>

            <!-- BOTONES DE ACCIÓN -->
            <div class="text-center mt-5">
              <button type="submit" class="btn btn-save me-3">
                <i class="bi bi-check-circle-fill me-2"></i>{{ accion }} Integrante
              </button>
              <a href="{% url 'core:panel_equipo' %}" class="btn btn-outline-secondary" onclick="return confirm('¿Estás seguro de cancelar? Los cambios no guardados se perderán.')">
                <i class="bi bi-arrow-left-circle-fill me-2"></i>Cancelar
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TEMPLATES PARA JAVASCRIPT -->
<template id="profesionalidad-template">
  <div class="dynamic-item border rounded">
    <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.remove()"></button>
    <div class="mb-2">
      <label class="form-label"><i class="bi bi-award-fill"></i> Rol / Cargo</label>
      <input type="text" name="profesionalidad_titulo" class="form-control" placeholder="Ej: Investigador Principal">
    </div>
    <div>
      <label class="form-label"><i class="bi bi-file-text"></i> Descripción de este rol (opcional)</label>
      <textarea name="profesionalidad_descripcion" class="form-control" rows="2" placeholder="Ej: A cargo del proyecto X..."></textarea>
    </div>
  </div>
</template>

<template id="universidad-template">
  <div class="dynamic-item border rounded">
    <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.remove()"></button>
    <div class="mb-2">
      <label class="form-label"><i class="bi bi-building"></i> Universidad</label>
      <input type="text" name="universidad_nombre" class="form-control" placeholder="Escribe el nombre de la Universidad">
    </div>
    <div>
      <label class="form-label"><i class="bi bi-file-text"></i> Descripción (opcional)</label>
      <textarea name="universidad_descripcion" class="form-control" rows="2" placeholder="Ej: Título obtenido, año de graduación..."></textarea>
    </div>
  </div>
</template>

<template id="interes-template">
  <div class="dynamic-item border rounded">
    <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.remove()"></button>
    <div class="mb-2">
      <label class="form-label"><i class="bi bi-star-fill"></i> Tema de Interés</label>
      <input type="text" name="interes_nombre" class="form-control" placeholder="Escribe el tema de interés">
    </div>
    <div>
      <label class="form-label"><i class="bi bi-file-text">